<?php
/*
  ___  _ __   ___ _   _  ___
 / _ \| '_ \ / _ \ | | |/ _ \
| (_) | | | |  __/ |_| |  __/
 \___/|_| |_|\___|\__, |\___|
                  |___/

oneye is released under the GNU Affero General Public License Version 3 (AGPL3)
 -> provided with this release in license.txt
 -> or via web at www.gnu.org/licenses/agpl-3.0.txt

Copyright Â© 2005 - 2010 eyeos Team (team@eyeos.org)
             since 2010 Lars Knickrehm (mail@lars-sh.de)
*/

function xenonEmbedder_on_ChooseApplicationIcon($params = null) {
	global $checknum, $myPid;
	
	proc('launch', array('eyeDialog', array(EYEDIALOG_TYPE_OPENFILE, 'ChooseApplicationIcon2', $checknum, null, array(
		'Image formats' => '*.bmp|*.gif|*.jpeg|*.jpg|*.png',
		'BMP files' => '*.bmp',
		'GIF files' => '*.gif',
		'JPEG files' => '*.jpeg',
		'JPG files' => '*.jpg',
		'PNG files' => '*.png',
		'All files' => '*.*'
	))));
	
	// Select default application value
	$GLOBALS['xenonEmbedder_Select_ApplicationIcon']->selectValue('exec');
	
	// Update imagebox
	xenonx('runjs', array('js' => 'xGetElementById("' . $myPid . '_xenonEmbedder_Imagebox_ApplicationIcon").src = "index.php?checknum=' . strval($checknum) . '&msg=GetApplicationIcon&icon=exec";'));
}

function xenonEmbedder_on_ChooseApplicationIcon2($params = null) {
	global $checknum, $myPid;
	
	include_once XENONOS_ROOT . '/' . SYSTEM_DIR . '/lib/eyeFiles/images' . XE_CODE_EXTENSION;
	
	// Validate image
	$image = images_imagecreatefromfile(vfs('getRealName', array(um('getCurrentUserDir') . '/' . FILES_USER_DIR . '/' . $params['arg'][0])));
	if ($image === false) {
		xenonx('messageBox', array('content' => 'Selected file is not an image.'));
		return;
	}
	
	// Destroy image
	imagedestroy($image);
	
	// Update select widget
	xenonx('runjs', array('js' => 'var i, options, select;
	select = xGetElementById("' . strval($myPid) . '_xenonEmbedder_Select_ApplicationIcon");
	options = select.getElementsByTagName("option");
	for (i = 0; i < options.length; i += 1) {
		if (options[i].value.substr(0, 7) === "custom:") {
			options[i].label = %s;
			options[i].value = %s;
			
			select.selectedIndex = options[i].index;
			break;
		}
	}', 'tokens' => array(i18n('translate', array('Custom: %s', array(basename($params['arg'][0])))), 'custom:' . $params['arg'][0])));
	
	// Update imagebox
	xenonx('runjs', array('js' => 'xGetElementById("' . $myPid . '_xenonEmbedder_Imagebox_ApplicationIcon").src = "index.php?checknum=' . strval($checknum) . '&msg=GetApplicationIcon&icon=custom:' . urlencode($params['arg'][0]) . '";'));
}

function xenonEmbedder_on_Close($params = null) {
	proc('end');
}

function xenonEmbedder_on_GetApplicationIcon($params = null) {
	include_once XENONOS_ROOT . '/' . APP_DIR . '/xenonEmbedder/libs' . XE_CODE_EXTENSION;
	
	$icon = isset($_REQUEST['icon']) && is_string($_REQUEST['icon']) ? $_REQUEST['icon'] : 'exec';
	
	header('Content-Disposition: inline; filename="' . basename($icon) . '.png"');
	header('Content-Type: image/png');
	header('Accept-Ranges: bytes');
	
	if (substr($icon, 0, 7) === 'custom:') {
		xenonEmbedder_lib_ResizeIcon(vfs('getRealName', array(um('getCurrentUserDir') . '/' . FILES_USER_DIR . '/' . substr($icon, 7))), null, 22);
	} else {
		$oldPath = XENONOS_ROOT . '/' . EXTERN_DIR . '/' . APP_DIR . '/xenonx/themes/default/icons';
		$icon = basename($icon) . '.png';
		
		if (is_file($oldPath . '/22x22/' . $icon)) {
			readfile($oldPath . '/22x22/' . $icon);
		} else {
			xenonEmbedder_lib_ResizeIcon($oldPath . '/48x48/' . $icon, null, 22);
		}
	}
	
	exit;
}

function xenonEmbedder_on_Message($params = null) {
	eyeWidgets('updateContent', $params);
}

function xenonEmbedder_on_Package($params = null) {
	global $checknum;
	
	include_once XENONOS_ROOT . '/' . APP_DIR . '/xenonEmbedder/libs' . XE_CODE_EXTENSION;
	
	list($applicationAuthor, $applicationCategory, $applicationDescription, $applicationIcon, $applicationLicense, $applicationName, $applicationType, $applicationVersion, $address, $defaultHeight, $defaultWidth, $title, $startMaximized) = array_values(xenonEmbedder_lib_GetValues());
	
	// Validate application name
	if (!xenonEmbedder_lib_ValidateApplicationName($applicationName)) {
		return;
	}
	
	// Get xePackage destination
	proc('launch', array('eyeDialog', array(EYEDIALOG_TYPE_SAVEFILE, 'Package2', $checknum, $applicationName . '.xepackage', array(
		'xePackage files' => '*.xepackage',
		'All files' => '*.*'
	))));
}

function xenonEmbedder_on_Package2($params = null) {
	include_once XENONOS_ROOT . '/' . APP_DIR . '/xenonEmbedder/libs' . XE_CODE_EXTENSION;
	
	list($applicationAuthor, $applicationCategory, $applicationDescription, $applicationIcon, $applicationLicense, $applicationName, $applicationType, $applicationVersion, $address, $defaultHeight, $defaultWidth, $title, $startMaximized) = array_values(xenonEmbedder_lib_GetValues());
	
	// Validate application name
	if (!xenonEmbedder_lib_ValidateApplicationName($applicationName)) {
		return;
	}
	
	// Retreive xePackage destination
	$xePackage = um('getCurrentUserDir') . '/' . FILES_USER_DIR . '/' . $params['arg'][0];
	
	// Create new temporary folder
	$i = 0;
	do {
		$temp = um('getCurrentUserDir') . '/' . TMP_USER_DIR . '/xenonEmbedder' . strval($i);
		$i += 1;
	} while (!vfs('real_mkDir', array($temp)));
	
	// Initialize temporary folder structure
	$package = $temp . '/' . APP_DIR;
	vfs('real_mkDir', array($package));
	
	$package .= '/' . $applicationName;
	vfs('real_mkDir', array($package));
	
	// Create or copy icons
	$newPath = xenonEmbedder_lib_CreateIconsPath($temp);
	$icon = $GLOBALS['xenonEmbedder_Select_ApplicationIcon']->selected;
	
	if (substr($icon, 0, 7) === 'custom:') {
		$oldPath = vfs('getRealName', array(um('getCurrentUserDir') . '/' . FILES_USER_DIR . '/' . substr($icon, 7)));
		
		xenonEmbedder_lib_ResizeIcon($oldPath, $newPath . '/48x48/' . $applicationName . '.png', 48);
		xenonEmbedder_lib_ResizeIcon($oldPath, $newPath . '/22x22/' . $applicationName . '.png', 22);
	} else {
		$oldPath = XENONOS_ROOT . '/' . EXTERN_DIR . '/' . APP_DIR . '/xenonx/themes/default/icons';
		$icon = basename($icon) . '.png';
		
		vfs('real_copy', array($oldPath . '/48x48/' . $icon, $newPath . '/48x48/' . $applicationName . '.png'));
		
		if (is_file($oldPath . '/22x22/' . $icon)) {
			vfs('real_copy', array($oldPath . '/22x22/' . $icon, $newPath . '/22x22/' . $applicationName . '.png'));
		} else {
			xenonEmbedder_lib_ResizeIcon($oldPath . '/48x48/' . $icon, $newPath . '/22x22/' . $applicationName . '.png', 22);
		}
	}
	
	// Fill temporary package folder with processed template data
	$template = XENONOS_ROOT . '/' . APP_DIR . '/' . APP_CONF_SHARE . '/xenonEmbedder/template';
	foreach (vfs('real_getDirContent', array($template)) as $file) {
		$content = vfs('real_getFileContent', array($file));
		
		// Replace keys by values
		foreach (xenonEmbedder_lib_GetValues() as $key => $value) {
			$replace = array(
				'%:' . $key . '%' => $value,
				'%i:' . $key . '%' => $value === null ? 'null' : (is_numeric($value) ? strval(intval($value)) : strval($value)),
				'%s:' . $key . '%' => $value === null ? 'null' : '\'' . str_replace(array('\\', '\''), array('\\\\', '\\\''), strval($value)) . '\'',
				'%x:' . $key . '%' => htmlspecialchars($value, ENT_NOQUOTES, 'UTF-8')
			);
			
			$content = str_replace(array_keys($replace), array_values($replace), $content);
		}
		
		// Replace escape character
		$content = str_replace('%%', '%', $content);
		
		vfs('real_putFileContent', array($package . '/' . basename($file), $content));
	}
	
	// Remove existing xePackage
	if (vfs('fileExists', array($xePackage))) {
		vfs('delete', array($xePackage));
	}
	
	// Create xePackage
	if (!eyeFileArchive('compress', array(array('simple' => array($temp . '/' . APP_DIR, $temp . '/' . EXTERN_DIR)), $xePackage, 'eqTypes' => array('xepackage' => 'tgz')))) {
		xenonx('messageBox', array('content' => 'Failed packaging.'));
	} else {
		eyeFiles('update', array(dirname($xePackage)));
	}
	
	// Remove temporary folder
	vfs('real_rmdir', array($temp));
	
	// Success
	xenonx('messageBox', array('content' => 'Package created.'));
}

function xenonEmbedder_on_Test($params = null) {
	include_once XENONOS_ROOT . '/' . APP_DIR . '/xenonEmbedder/libs' . XE_CODE_EXTENSION;
	
	list($applicationAuthor, $applicationCategory, $applicationDescription, $applicationIcon, $applicationLicense, $applicationName, $applicationType, $applicationVersion, $address, $defaultHeight, $defaultWidth, $title, $startMaximized) = array_values(xenonEmbedder_lib_GetValues());
	
	// Validate application name
	if (!xenonEmbedder_lib_ValidateApplicationName($applicationName)) {
		return;
	}
	
	// Launch eyeIframize
	proc('launch', array('eyeIframize', array(
		$address,
		$title,
		$defaultWidth,
		$defaultHeight,
		$startMaximized
	)));
}
?>