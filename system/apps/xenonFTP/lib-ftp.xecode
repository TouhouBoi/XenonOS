<?php
/*
  ___  _ __   ___ _   _  ___
 / _ \| '_ \ / _ \ | | |/ _ \
| (_) | | | |  __/ |_| |  __/
 \___/|_| |_|\___|\__, |\___|
                  |___/

oneye is released under the GNU Affero General Public License Version 3 (AGPL3)
 -> provided with this release in license.txt
 -> or via web at www.gnu.org/licenses/agpl-3.0.txt

Copyright Â© 2005 - 2010 eyeos Team (team@eyeos.org)
             since 2010 Lars Knickrehm (mail@lars-sh.de)
*/

include_once(XENONOS_ROOT.'/'.APP_DIR.'/xenonFTP/lib-global'.XE_CODE_EXTENSION);
include_once(XENONOS_ROOT.'/'.APP_DIR.'/xenonFTP/lib-remote'.XE_CODE_EXTENSION);

/*********************************************************************************************/
/*********************************************************************************************/
/*					FTP FUNCTIONS															 */
/*********************************************************************************************/
/*********************************************************************************************/

/**
 * Connect to host with specified informations.
 *
 * @param string $host The hostname
 * @param int $port The port
 * @param string $username The username
 * @param string $password The password
 * @param mixed $passiveMode A true value to use passive mode for transfers, a false one otherwise
 * @param boolean $silentSuccess [optional] Hides successful connection and authentication
 * 											messages in log console if TRUE (default: FALSE)
 * @param int $timeout [optional] The timeout (default: 10)
 * @return boolean TRUE if connection is successful, FALSE otherwise
 */
function xenonFTP_ftpConnect($host,$port,$username,$password,$passiveMode,$silentSuccess = false,$timeout = 10) {
	$ftpResource = ftp_connect($host,$port,$timeout);
	if ($ftpResource === false) {
		xenonFTP_logConsole('Failed to connect to specified host!', null, xenonFTP_LOGSTYLE_ERROR);
		xenonFTP_setConnectionActive(false);
		return false;
	}

	if (! $silentSuccess) {
		xenonFTP_logConsole('Connection accepted', null, xenonFTP_LOGSTYLE_SUCCESS);
		xenonFTP_logConsole('Authenticating user...');
	}
	if (ftp_login($ftpResource,$username,$password) === false) {
		xenonFTP_logConsole('Authentication failed. Invalid username/password!', null, xenonFTP_LOGSTYLE_ERROR);
		xenonFTP_setConnectionActive(false);
		return false;
	}

	if (! $silentSuccess) {
		xenonFTP_logConsole('User "%s" authenticated successfully',
			array($username),
			xenonFTP_LOGSTYLE_SUCCESS
		);
	}

	if ($passiveMode) {
		if (ftp_pasv($ftpResource,true) === false) {
			xenonFTP_logConsole('Passive mode failed! Data transfers will be performed in active mode', null, xenonFTP_LOGSTYLE_WARNING);
		}
		else {
			if (! $silentSuccess)
				xenonFTP_logConsole('Passive mode accepted', null, xenonFTP_LOGSTYLE_SUCCESS);
		}
	}

	$GLOBALS['xenonFTP_ftpConnectionResource'] = $ftpResource;
	xenonFTP_setConnectionActive(true);
	return true;
}

function xenonFTP_ftpPwd() {
	$conf = xenonFTP_getConf();
	if (! xenonFTP_autoConnect()) {
		return false;
	}
	return ftp_pwd($GLOBALS['xenonFTP_ftpConnectionResource']);
}

/**
 * List files located in the directory passed in argument.
 *
 * @param string $dir The absolute path of the directory to browse
 * @return boolean TRUE if the operation is successful, FALSE otherwise
 */
function xenonFTP_ftpListDir($dir) {
	$conf = xenonFTP_getConf();
	if (! xenonFTP_autoConnect()) {
		return false;
	}
	if (! ftp_chdir($GLOBALS['xenonFTP_ftpConnectionResource'],'/'.$dir)) {
		xenonFTP_logConsole('Unable to list files, error occured', null, xenonFTP_LOGSTYLE_ERROR);
		return false;
	}
	$dir = xenonFTP_ftpPwd($GLOBALS['xenonFTP_ftpConnectionResource']);

	$listCmdArguments = ($GLOBALS['xenonFTP_listA_HID']->text)? '-a' : '';
	$contents = ftp_rawlist($GLOBALS['xenonFTP_ftpConnectionResource'],$listCmdArguments.' '.$dir);
	if ($contents === false) {
		xenonFTP_logConsole('Unable to list files, error occured. (Do you have sufficient permissions?)', null, xenonFTP_LOGSTYLE_ERROR);
		return false;
	}

	xenonFTP_emptyRemoteFilesTable();

	$nbFiles = -1;	//start from -1 to ignore parent folder entry
	$filesData = parse_rawlist($contents);
	foreach($filesData as $id => $fileInfo) {
		switch($fileInfo['type']) {
			case 'd':
				$urlIcon = 'index.php?theme=' . $_SESSION['usertheme'] . '&extern=icons/16x16/folder.png';
				$size = ' ';
				break;

			case 'l':
				$urlIcon = 'index.php?theme=' . $_SESSION['usertheme'] . '&extern=icons/16x16/link.png';
				$size  = $fileInfo['size'];
				break;

			default:
				$urlIcon = 'index.php?theme=' . $_SESSION['usertheme'] . '&extern=icons/16x16/file.png';
				$size  = $fileInfo['size'];
		}
		$GLOBALS['xenonFTP_remoteFiles_TAB']->addRow(array(
			'<img src="'.$urlIcon.'" />',
			$fileInfo['displayedName'],
			$size,
			$fileInfo['year-time'] . '-' . $fileInfo['month'] . '-' . $fileInfo['day'],
			$fileInfo['perms'],
			$fileInfo['owner'],
			$id
		));
		$nbFiles++;
	}
	$GLOBALS['xenonFTP_serializedRemoteFilesData_HID']->setText(serialize($filesData));
	$GLOBALS['xenonFTP_currentRemoteDir_HID']->setText($dir);

	//FIXME: unable to use setText(), otherwise causes an "undefined entity" error on special chars in browser
	//$GLOBALS['xenonFTP_path_TXTBOX']->setText($dir);
	global $myPid;
	xenonx('rawjs',array('js' => 'document.getElementById("'.$myPid.'_xenonFTP_remotePath_TXTBOX").value=Base64.decode("'.base64_encode($dir).'");'));

	xenonFTP_logConsole('Directory listing successful for "%s" (%s file(s) found)',
		array($dir,$nbFiles),
		xenonFTP_LOGSTYLE_SUCCESS
	);
	return true;
}

/**
 * FTP FILE => BROWSER
 *
 * @param string $dir The path of the directory holding the file
 * @param string $filename The filename
 * @return boolean TRUE if the operation is successful, FALSE otherwise
 */
function xenonFTP_ftpGetToBrowser($dir,$filename) {
	xenonFTP_prepareLongExecution();
	global $myPid,$checknum;

	if (! xenonFTP_autoConnect()) {
		return false;
	}

	//create a temporay file to receive data
	$tmpFilePath = um('getCurrentUserDir').TMP_USER_DIR.'/'.uniqid('xenonFTP').'.tmp';
	$tmpFileCreation = vfs('real_create',array($tmpFilePath));
	$tmpFile = vfs('real_open',array($tmpFilePath,'w'));
	if (!$tmpFileCreation || $tmpFile === false) {
		xenonFTP_logConsole('Unable to create temporary file! Download aborted.', null, xenonFTP_LOGSTYLE_ERROR);
		return false;
	}

	if (ftp_fget($GLOBALS['xenonFTP_ftpConnectionResource'],
						$tmpFile,
						xenonFTP_getFormatedDirPath($dir.'/'.$filename),
						FTP_BINARY,
						0) !== true) {
		xenonFTP_logConsole('Error while downloading file! Transfer aborted.', null, xenonFTP_LOGSTYLE_ERROR);
		return false;
	}
	fclose($tmpFile);
	clearstatcache();
	$filesize = vfs('real_filesize', array($tmpFilePath));

	//send the response back to the browser (update dummy iframe)
	$params = array();
	$params['tmpfilepath'] = $tmpFilePath;
	$params['filename'] = $filename;
	$params = urlencode(serialize($params));
	xenonx('rawjs',array('js' => "document.getElementById('".$myPid."_xenonFTP_download_FRM').src='index.php?checknum=$checknum&msg=xenonFTP_downloadRemote_finished&params=".$params."';"));

	xenonFTP_logConsole('Download finished successfully, %s bytes transfered.',
		array($filesize),
		xenonFTP_LOGSTYLE_SUCCESS
	);
	return true;
}

/**
 * FTP FILE => ONEYE FILE
 *
 * @param string $filePath The path of the FTP file to retrieve
 * @param string $localDirPath The path of the target local directory
 * @return boolean TRUE if the operation is successful, FALSE otherwise
 */
function xenonFTP_ftpGetToeyeOS_file($filePath,$localDirPath) {
	xenonFTP_prepareLongExecution();
	if (! xenonFTP_autoConnect()) {
		return false;
	}
	$filePath = xenonFTP_getFormatedDirPath($filePath);
	$filename = basename($filePath);
	$localFilePath = xenonFTP_getFormatedDirPath($localDirPath.'/'.$filename);

	$filesize = ftp_size($GLOBALS['xenonFTP_ftpConnectionResource'], $filePath);
	if (!vfs('checkQuota',array($filesize))) {
		xenonFTP_logConsole('Unable to download file "%s": quota reached.', array($filename), xenonFTP_LOGSTYLE_ERROR);
		return false;
	}
	if(vfs('fileExists',array($localFilePath,'xenonFTP'))) {
		xenonFTP_logConsole('File "%s" already exists, overwriting.', array($filePath), xenonFTP_LOGSTYLE_WARNING);
	}
	elseif(! vfs('create',array($localFilePath,'xenonFTP'))) {
		xenonFTP_logConsole('Unable to create file "%s".', array($filePath), xenonFTP_LOGSTYLE_ERROR);
		return false;
	}
	$fp = vfs('open',array($localFilePath,'w'));
	if(! $fp) {
		xenonFTP_logConsole('Unable to write file, try to check permissions.', null, xenonFTP_LOGSTYLE_ERROR);
		return false;
	}

	if (ftp_fget($GLOBALS['xenonFTP_ftpConnectionResource'],
						$fp,
						$filePath,
						FTP_BINARY,
						0) !== true) {
		xenonFTP_logConsole('Error while downloading file "%s"! Transfer aborted.', array($filename), xenonFTP_LOGSTYLE_ERROR);
		return false;
	}
	fclose($fp);
	xenonFTP_logConsole('Download of file "%s" finished.',
		array($filePath),
		xenonFTP_LOGSTYLE_SUCCESS
	);
	return true;
}

/**
 * FTP DIR => ONEYE DIR
 *
 * @param string $dirPath The path of the FTP directory to retrieve
 * @param string $localDirPath The path of the target local directory
 * @return boolean TRUE if the operation is successful, FALSE otherwise
 */
function xenonFTP_ftpGetToeyeOS_dir($dirPath,$localDirPath) {
	xenonFTP_prepareLongExecution();
	if (! xenonFTP_autoConnect()) {
		return false;
	}
	$dirPath = xenonFTP_getFormatedDirPath($dirPath);
	$dirname = basename($dirPath);
	$localDirPath = xenonFTP_getFormatedDirPath($localDirPath.'/'.$dirname);
	if (! vfs('isdir', array($localDirPath))) {
		if (! vfs('mkdir', array($localDirPath))) {
			xenonFTP_logConsole('Unable to create directory "%s".', array($dirname), xenonFTP_LOGSTYLE_ERROR);
			return false;
		}
	}

	$listCmdArguments = ($GLOBALS['xenonFTP_listA_HID']->text)? '-a' : '';
	$contents = ftp_rawlist($GLOBALS['xenonFTP_ftpConnectionResource'],$listCmdArguments.' '.$dirPath);
	if ($contents === false) {
		xenonFTP_logConsole('Unable to browse directory\'s content at "%s".', array($dirPath), xenonFTP_LOGSTYLE_ERROR);
		return false;
	}
	$filesData = parse_rawlist($contents,false);
	foreach($filesData as $id => $fileInfo) {
		switch($fileInfo['type']) {
			case 'd':
				xenonFTP_ftpGetToeyeOS_dir($dirPath.'/'.$fileInfo['name'],$localDirPath);
				break;

			case 'l':
				//links must be ignored
				break;

			default:
				xenonFTP_ftpGetToeyeOS_file($dirPath.'/'.$fileInfo['name'],$localDirPath);
		}
	}
	xenonFTP_logConsole('Download of directory "%s" finished.',
		array($dirPath),
		xenonFTP_LOGSTYLE_SUCCESS
	);
	return true;
}

/**
 * BROWSER => FTP FILE
 *
 * @param string $tmpLocalFilePath The path of the temporary file
 * @param string $dirPath The target FTP directory
 * @param string $originalFileName The original name of the file
 * @return boolean TRUE if the operation is successful, FALSE otherwise
 */
function xenonFTP_ftpPutFromBrowser($tmpLocalFilePath, $dirPath, $originalFileName) {
	xenonFTP_prepareLongExecution();
	if (! xenonFTP_autoConnect()) {
		return false;
	}
	$dirPath = xenonFTP_getFormatedDirPath($dirPath);

	$fp = fopen($tmpLocalFilePath,'r');
	if ($fp !== false) {
		if (ftp_fput($GLOBALS['xenonFTP_ftpConnectionResource'],
						$dirPath.'/'.$originalFileName,$fp,
						FTP_BINARY,
						0) === true) {
			xenonFTP_logConsole('Upload finished successfully, %s bytes transfered.',
				array(filesize($tmpLocalFilePath)),
				xenonFTP_LOGSTYLE_SUCCESS
			);
		}
		else {
			xenonFTP_logConsole('Error while uploading file! Transfer aborted. (Do you have sufficient permissions?)',
				null,
				xenonFTP_LOGSTYLE_ERROR
			);
			return false;
		}
		fclose($fp);
	}
	else {
		xenonFTP_logConsole('Unable to read temporary file! Upload aborted.', null, xenonFTP_LOGSTYLE_ERROR);
		return false;
	}
	return true;
}

/**
 * ONEYE FILE => FTP FILE
 *
 * @param string $localFilePath The path of the local file
 * @param string $dirPath The path of the target FTP directory
 * @return boolean TRUE if the operation is successful, FALSE otherwise
 */
function xenonFTP_ftpPutFromEyeOS_file($localFilePath,$dirPath) {
	xenonFTP_prepareLongExecution();
	if (! xenonFTP_autoConnect()) {
		return false;
	}
	$localFilePath = xenonFTP_getFormatedDirPath($localFilePath);
	$filename = basename($localFilePath);
	$remoteFilePath = xenonFTP_getFormatedDirPath($dirPath.'/'.$filename);
	$displayedLocalFilePath = xenonFTP_getFormatedDirPath(xenonFTP_resolvePathInUserDir(dirname($localFilePath)).'/'.$filename);

	$fp = vfs('open',array($localFilePath,'r'));
	if(! $fp) {
		xenonFTP_logConsole('Unable to read file "%s"', array($displayedLocalFilePath), xenonFTP_LOGSTYLE_ERROR);
		return false;
	}

	if (ftp_fput($GLOBALS['xenonFTP_ftpConnectionResource'],
						$remoteFilePath,
						$fp,
						FTP_BINARY,
						0) !== true) {
		xenonFTP_logConsole('Error while uploading file "%s"! Transfer aborted.', array($displayedLocalFilePath), xenonFTP_LOGSTYLE_ERROR);
		fclose($fp);
		return false;
	}
	fclose($fp);
	xenonFTP_logConsole('Upload of file "%s" finished.',array($displayedLocalFilePath),xenonFTP_LOGSTYLE_SUCCESS);
	return true;
}

/**
 * ONEYE DIR => FTP DIR
 *
 * @param string $localDirPath The path of the local directory
 * @param string $dirPath The path of the target FTP directory
 * @return boolean TRUE if the operation is successful, FALSE otherwise
 */
function xenonFTP_ftpPutFromEyeOS_dir($localDirPath,$dirPath) {
	xenonFTP_prepareLongExecution();
	if (! xenonFTP_autoConnect()) {
		return false;
	}
	$dirPath = xenonFTP_getFormatedDirPath($dirPath);
	$dirname = basename($localDirPath);
	$currentRemoteDir = xenonFTP_ftpPwd();
	$remoteDirPath = xenonFTP_getFormatedDirPath($dirPath.'/'.$dirname);

	//check directory's existence, create it if needed (ftp_chdir is the best way to check that)
	if (! ftp_chdir($GLOBALS['xenonFTP_ftpConnectionResource'],$remoteDirPath)) {
		if (!xenonFTP_ftpMkdir($dirPath,$dirname)) {
			return false;
		}
	}
	else {
		//the directory already exists, go back to previous directory
		ftp_chdir($GLOBALS['xenonFTP_ftpConnectionResource'],$currentRemoteDir);
	}

	$filesData = xenonFTP_listDir($localDirPath,false);
	foreach($filesData as $id => $fileInfo) {
		switch($fileInfo['type']) {
			case 'd':
				xenonFTP_ftpPutFromEyeOS_dir($localDirPath.'/'.$fileInfo['name'],$remoteDirPath);
				break;

			case 'l':
				//links must be ignored
				break;

			default:
				xenonFTP_ftpPutFromEyeOS_file($localDirPath.'/'.$fileInfo['name'],$remoteDirPath);
		}
	}
	xenonFTP_logConsole('Upload of directory "%s" finished.',
		array(xenonFTP_resolvePathInUserDir($localDirPath)),
		xenonFTP_LOGSTYLE_SUCCESS
	);
	return true;
}

/**
 * Attemps to create a folder in the designated directory.
 *
 * @param string $dir The path to the directory where to create the new folder
 * @param string $foldername The name of the folder
 * @return boolean TRUE if the operation is successful, FALSE otherwise
 */
function xenonFTP_ftpMkdir($dir,$foldername) {
	if (! xenonFTP_autoConnect()) {
		return false;
	}

	if (ftp_mkdir($GLOBALS['xenonFTP_ftpConnectionResource'],xenonFTP_getFormatedDirPath($dir.'/'.$foldername)) == false) {
		xenonFTP_logConsole('Unable to create directory, error occured. (Do you have sufficient permissions?)',
			null,
			xenonFTP_LOGSTYLE_ERROR
		);
		return false;
	}
	else {
		xenonFTP_logConsole('Directory "%s" created successfully',
			array(xenonFTP_getFormatedDirPath($dir.'/'.$foldername)),
			xenonFTP_LOGSTYLE_SUCCESS
		);
		return true;
	}
}

/**
 * Attempts to rename/move a file or folder
 *
 * @param string $currentFileLocation The path of the file/folder
 * @param string $newFileLocation The new path/name of the file/folder
 * @return boolean TRUE if the operation is successful, FALSE otherwise
 */
function xenonFTP_ftpRename($currentFileLocation,$newFileLocation) {
	if (! xenonFTP_autoConnect()) {
		return false;
	}

	if (ftp_rename($GLOBALS['xenonFTP_ftpConnectionResource'],$currentFileLocation,$newFileLocation) == false) {
		xenonFTP_logConsole('Unable to rename selection, error occured. (Do you have sufficient permissions?)',
			null,
			xenonFTP_LOGSTYLE_ERROR
		);
		return false;
	}
	else {
		xenonFTP_logConsole('File/folder renamed successfully', null, xenonFTP_LOGSTYLE_SUCCESS);
		return true;
	}
}

/**
 * Attempts to delete a file or folder
 *
 * @param string $filePath The path of the file/folder
 * @param string $fileType The type of the element (the character returned by the LIST command: 'd', '-', 'l')
 * @return boolean TRUE if the operation is successful, FALSE otherwise
 */
function xenonFTP_ftpDelete($filePath,$fileType,$recursive=true) {
	if (! xenonFTP_autoConnect()) {
		return false;
	}
	$filePath = xenonFTP_getFormatedDirPath($filePath);

	//FOLDER
	if ($fileType == 'd') {
		xenonFTP_prepareLongExecution();
		$listCmdArguments = ($GLOBALS['xenonFTP_listA_HID']->text)? '-a' : '';
		$contents = ftp_rawlist($GLOBALS['xenonFTP_ftpConnectionResource'],$listCmdArguments.' '.$filePath);
		if ($contents === false) {
			xenonFTP_logConsole('Unable to delete directory\'s content at "%s".', array($filePath), xenonFTP_LOGSTYLE_ERROR);
			return false;
		}
		$filesData = parse_rawlist($contents,false);
		foreach($filesData as $id => $fileInfo) {
			xenonFTP_ftpDelete($filePath.'/'.$fileInfo['name'],$fileInfo['type']);
		}

		if (ftp_rmdir($GLOBALS['xenonFTP_ftpConnectionResource'],$filePath) == false) {
			xenonFTP_logConsole('Unable to delete folder, error occured. (Do you have sufficient permissions?)',
				null,
				xenonFTP_LOGSTYLE_ERROR
			);
			return false;
		}
		else {
			xenonFTP_logConsole('Folder "%s" deleted successfully', array($filePath), xenonFTP_LOGSTYLE_SUCCESS);
			return true;
		}
	}
	//FILE (OR LINK)
	else {
		if (ftp_delete($GLOBALS['xenonFTP_ftpConnectionResource'],$filePath) == false) {
			xenonFTP_logConsole('Unable to delete file, error occured. (Do you have sufficient permissions?)',
				null,
				xenonFTP_LOGSTYLE_ERROR
			);
			return false;
		}
		else {
			xenonFTP_logConsole('File "%s" deleted successfully', array($filePath), xenonFTP_LOGSTYLE_SUCCESS);
			return true;
		}
	}
}

?>